Alfresco.forms=Alfresco.forms||{};Alfresco.forms.validation=Alfresco.forms.validation||{};(function(){var d=YAHOO.util.Dom,b=YAHOO.util.Event,a=YAHOO.util.Selector,c=YAHOO.util.KeyListener;Alfresco.forms.Form=function(e){this.formId=e;this.validateOnSubmit=true;this.validateAllOnSubmit=false;this.showSubmitStateDynamically=false;this.showSubmitStateDynamicallyErrors=false;this.submitAsJSON=false;this.submitElements=[];this.validations=[];this.ajaxSubmit=false;this.ajaxSubmitMethod="POST";this.errorContainer="alert";return this};Alfresco.forms.Form.prototype={formId:null,submitElements:null,validateOnSubmit:null,validateAllOnSubmit:null,showSubmitStateDynamically:null,showSubmitStateDynamicallyErrors:null,ajaxSubmit:null,errorContainer:null,doBeforeFormSubmit:{fn:function(e,f){},obj:null,scope:this},doBeforeAjaxRequest:{fn:function(e,f){return true},obj:null,scope:this},ajaxSubmitHandlers:null,ajaxSubmitMethod:null,submitAsJSON:null,validations:null,init:function(){var h=d.get(this.formId);if(h!==null){if(h.getAttribute("forms-runtime")!="listening"){b.addListener(h,"submit",this._submitInvoked,this,true);h.setAttribute("forms-runtime","listening");if(this.ajaxSubmit){h.setAttribute("onsubmit","return false;")}}if(h.getAttribute("enctype")&&h.getAttribute("enctype")=="application/json"){this.ajaxSubmit=true;this.submitAsJSON=true}if(this.showSubmitStateDynamically){if(this.submitElements.length==0){var f=a.query("#"+this.formId+' > input[type="submit"]');for(var e=0,i=f.length;e<i;e++){var g=f[e];this.submitElements.push(g.id)}}this.updateSubmitElements()}}else{this._showInternalError("form with id of '"+this.formId+"' could not be located, ensure the form is created after the form element is available.")}},setValidateOnSubmit:function(e){this.validateOnSubmit=e},setValidateAllOnSubmit:function(e){this.validateAllOnSubmit=e},setSubmitElements:function(e){if(!YAHOO.lang.isArray(e)){this.submitElements[0]=e}else{this.submitElements=e}},setErrorContainer:function(e){this.errorContainer=e},setRepeatable:function(f,e){alert("not implemented yet")},setShowSubmitStateDynamically:function(e,f){this.showSubmitStateDynamically=e;if(f){this.showSubmitStateDynamicallyErrors=f}},setAJAXSubmit:function(f,e){this.ajaxSubmit=f;this.ajaxSubmitHandlers=e},setSubmitAsJSON:function(e){this.submitAsJSON=e},setAjaxSubmitMethod:function(e){this.ajaxSubmitMethod=e},addValidation:function(g,h,l,e,i){var j=d.get(g);if(j==null){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Ignoring validation for field with id of '"+g+"' as it could not be located.")}return}if(h===undefined||h===null){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Ignoring validation for field with id of '"+g+"' as a validationHandler was not provided.")}return}if(i===undefined){i=null}var f={fieldId:g,args:l,handler:h,message:i};this.validations.push(f);if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Added submit validation for field: "+g+", using handler: "+(h.name||YAHOO.lang.dump(h))+", args: "+YAHOO.lang.dump(l))}if(e&&e.length>0){b.addListener(j,e,this._validationEventFired,f,this);if(YAHOO.env.ua.ie>0&&e=="propertychange"){var k=this;j.attachEvent("onpropertychange",function(m){k._validationEventFired(m,f)})}if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Added field validation for field: "+g+", using handler: "+(h.name||YAHOO.lang.dump(h))+", args: "+YAHOO.lang.dump(l)+", on event: "+e)}}},addError:function(i,g){YAHOO.Bubbling.fire("formValidationError",{msg:i,field:g});if(this.errorContainer!==null){if(this.errorContainer==="alert"){alert(i)}else{var f=d.get(this.errorContainer);if(f!==null){f.style.display="block";var e=f.innerHTML;var h=f.innerHTML+"<div>"+i+"</div>";f.innerHTML=h}}}},addSubmitElement:function(e){if(e!==null){this.submitElements.push(e);this.updateSubmitElements()}},getFieldLabel:function(g){var h=null;var f=a.query("label");if(f.length>0){for(var e=0,j=f.length;e<j;e++){var i=f[e];if(i.htmlFor==g){h=i.firstChild.nodeValue}}}if(h==null){h=g}return h},getFormData:function(){var e=d.get(this.formId);return this._buildAjaxForSubmit(e)},applyTabFix:function(){if(YAHOO.env.ua.gecko>0){var g=d.get(this.formId);var f=function(k,i){var h=i[1];var j=h.target;if(!j.hasAttribute("tabindex")){b.stopEvent(h);a.query("[tabindex]",g)[0].focus()}};var e=new c(g,{keys:c.KEY.TAB},f,"keyup");e.enable()}},updateSubmitElements:function(){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Determining whether submit elements can be enabled...")}var g=this._runValidations(true);for(var e=0,h=this.submitElements.length;e<h;e++){var f=this.submitElements[e];if(f){if(typeof f=="string"){d.get(f).disabled=!g}else{f.set("disabled",!g)}}}},_clearErrors:function(){if(this.errorContainer!=="alert"){var e=d.get(this.errorContainer);if(e!==null){e.style.display="none";e.innerHTML=""}}},_validationEventFired:function(g,f){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Event has been fired for field: "+f.fieldId)}var e=false;if(this.showSubmitStateDynamically){if(this.showSubmitStateDynamicallyErrors){this._clearErrors()}else{e=true}}f.handler(b.getTarget(g),f.args,g,this,e,f.message);if(this.showSubmitStateDynamically){this.updateSubmitElements()}},_submitInvoked:function(j){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Submit invoked on formId: ",this.formId)}this._clearErrors();if(this.validateOnSubmit){var e=false;if(this.showSubmitStateDynamically&&!this.showSubmitStateDynamicallyErrors){e=true}if(this._runValidations(e)){var i=d.get(this.formId);this.doBeforeFormSubmit.fn.call(this.doBeforeFormSubmit.scope,i,this.doBeforeFormSubmit.obj);if(this.ajaxSubmit){b.stopEvent(j);var l=i.attributes.action.nodeValue;if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Performing AJAX submission to url: ",l)}if(i.enctype&&i.enctype=="multipart/form-data"){var k=i.ownerDocument;var h=k.createElement("iframe");h.style.display="none";d.generateId(h,"formAjaxSubmit");h.name=h.id;document.body.appendChild(h);window.frames[h.name].name=h.name;i.target=h.name;i.submit();return}var f={method:this.ajaxSubmitMethod,url:l};if(this.ajaxSubmitHandlers){f=YAHOO.lang.merge(f,this.ajaxSubmitHandlers)}if(this.submitAsJSON){var g=this._buildAjaxForSubmit(i);f.dataObj=g;if(this.doBeforeAjaxRequest.fn.call(this.doBeforeAjaxRequest.scope,f,this.doBeforeAjaxRequest.obj)){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Submitting JSON data: ",f.dataObj)}Alfresco.util.Ajax.jsonRequest(f)}else{if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("JSON data request cancelled in doBeforeAjaxRequest()")}}}else{if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Submitting data in form: ",i.enctype)}f.dataForm=i;Alfresco.util.Ajax.request(f)}}}else{b.stopEvent(j);if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Submission prevented as validation failed")}}}else{if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Ignoring validations as submission validation is disabled")}}},_buildAjaxForSubmit:function(f){if(f!==null){var h={},g=f.elements.length;for(var o=0;o<g;o++){var p=f.elements[o],e=p.name;if(e=="-"||p.disabled||p.type==="button"){continue}if(e==undefined||e==""){e=p.id}var t=(p.type==="textarea")?p.value:Alfresco.util.trim(p.value);if(e){if((e.length>2)&&(e.substring(e.length-2)=="[]")){e=e.substring(0,e.length-2);if(h[e]===undefined){h[e]=new Array()}h[e].push(t)}else{if(e.indexOf(".")>0){var s=e.split(".");var n=h;var r;for(var m=0,l=s.length-1;m<l;m++){r=s[m];if(n[r]===undefined){n[r]={}}n=n[r]}n[s[m]]=t}else{if(!((p.type==="checkbox"||p.type==="radio")&&!p.checked)){if(p.type=="select-multiple"){for(var m=0,q=p.options.length;m<q;m++){if(p.options[m].selected){if(h[e]==undefined){h[e]=new Array()}h[e].push(p.options[m].value)}}}else{h[e]=t}}}}}}return h}},_runValidations:function(f){var g=false;for(var e=0,j=this.validations.length;e<j;e++){var i=this.validations[e];var h=d.get(i.fieldId);if(h!==null&&!h.disabled){if(!i.handler(h,i.args,null,this,f,i.message)){g=true;if(!this.validateAllOnSubmit){if(!f){h.focus()}break}}}}return !g},_showInternalError:function(f,e){this.addError("Internal Form Error: "+f,e)}}})();(function(){Alfresco.forms.validation.mandatory=function g(A,y,s,t,v,B){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Validating mandatory state of field '"+A.id+"'")}var q=true;if(A.type&&A.type=="radio"){var r=Dom.get(t.formId),w=r[A.name],p=false;for(var z=0,o=w.length;z<o;z++){if(w[z].checked){p=true;break}}q=p}else{q=YAHOO.lang.trim(A.value).length!==0}if(!q&&!v&&t){if(s&&s.keyCode!=9&&s.keyCode!=16||!s){var u=(B!=null)?B:"is mandatory.";t.addError(u,A)}}return q};Alfresco.forms.validation.length=function c(v,u,p,q,t,x){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Validating length of field '"+v.id+"' using args: "+YAHOO.lang.dump(u))}var o=true;var w=YAHOO.lang.merge({min:-1,max:-1,crop:false,includeWhitespace:true},u);if(w.minLength){w.min=w.minLength}if(w.maxLength){w.max=w.maxLength}var r=w.includeWhitespace?v.value.length:YAHOO.lang.trim(v.value).length;if(w.min!=-1&&r<w.min){o=false}if(w.max!=-1&&r>w.max){o=false;if(w.crop){if(w.includeWhitespace){v.value=YAHOO.lang.trim(v.value)}if(v.value.length>w.max){v.value=v.value.substring(0,w.max)}if(v.type&&v.type=="textarea"){v.scrollTop=v.scrollHeight}o=true}}if(!o&&!t&&q){var s=(x!=null)?x:"is not the correct length.";q.addError(s,v)}return o};Alfresco.forms.validation.number=function e(w,v,p,q,u,y){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Validating field '"+w.id+"' is a number")}var s=false;if(v!==null&&v.repeating){s=true}var o=true;if(s){var x=w.value.split(",");for(var t=0;t<x.length;t++){o=(isNaN(x[t])==false);if(!o){break}}}else{o=(isNaN(w.value)==false)}if(!o&&!u&&q){var r=(y!=null)?y:"is not a number.";q.addError(r,w)}return o};Alfresco.forms.validation.numberRange=function n(w,u,p,q,t,y){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Validating number range of field '"+w.id+"' using args: "+YAHOO.lang.dump(u))}var o=true;var x=w.value.toString();if(x.length>0){if(isNaN(x)){o=false;if(!t&&q){var r=(y!=null)?y:"is not a number.";q.addError(r,w)}}else{var s=-1;var v=-1;if(u.min){s=parseInt(u.min)}if(u.minValue){s=parseInt(u.minValue)}if(u.max){v=parseInt(u.max)}if(u.maxValue){v=parseInt(u.maxValue)}if(s!=-1&&x<s){o=false}if(v!=-1&&x>v){o=false}if(!o&&!t&&q){var r=(y!=null)?y:"is not within the allowable range.";q.addError(r,w)}}}return o};Alfresco.forms.validation.nodeName=function k(t,p,s,r,o,q){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Validating field '"+t.id+"' is a valid node name")}if(!p){p={}}p.pattern=/([\"\*\\\>\<\?\/\:\|]+)|([\.]?[\.]+$)/;p.match=false;return Alfresco.forms.validation.regexMatch(t,p,s,r,o,q)};Alfresco.forms.validation.wikiTitle=function f(t,p,s,r,o,q){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Validating field '"+t.id+"' is a valid node name")}if(!p){p={}}p.pattern=/([\\\?\/\|]+)|([\.]?[\.]+$)/;p.match=false;return Alfresco.forms.validation.regexMatch(t,p,s,r,o,q)};Alfresco.forms.validation.nodeRef=function l(t,p,s,r,o,q){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Validating field '"+t.id+"' is a valid noderef")}if(!p){p={}}p.pattern=/^[^\:^ ]+\:\/\/[^\:^ ]+\/[^ ]+$/;return Alfresco.forms.validation.regexMatch(t,p,s,r,o,q)};Alfresco.forms.validation.email=function i(t,p,s,r,o,q){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Validating field '"+t.id+"' is a valid email address")}if(!p){p={}}p.pattern=/(.+@.+\.[a-zA-Z0-9]{2,6})/;p.match=true;return Alfresco.forms.validation.regexMatch(t,p,s,r,o,q)};Alfresco.forms.validation.time=function d(t,p,s,r,o,q){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Validating field '"+t.id+"' is a valid time value")}if(!p){p={}}p.pattern=/^([0-1]\d|2[0-3]):[0-5]\d(:[0-5]\d)?$/;p.match=true;return Alfresco.forms.validation.regexMatch(t,p,s,r,o,q)};Alfresco.forms.validation.url=function b(w,v,p,q,s,x){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Validating field '"+w.id+"' is a valid URL")}var u=/(ftp|http|https):\/\/[\w\-_]+(\.[\w\-_]+)*([\w\-\.,@?^=%&:/~\+#]*[\w\-\@?^=%&/~\+#])?/,o=true;if(w.value.length>0){var t=new RegExp(u);o=w.value.replace(t,"")==="";if(!o&&!s&&q){var r=(x!=null)?x:"is invalid.";q.addError(r,w)}}return o};Alfresco.forms.validation.regexMatch=function m(v,u,p,q,s,w){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Validating regular expression of field '"+v.id+"' using args: "+YAHOO.lang.dump(u))}var o=true;if(v.value.length>0){if(u.match===undefined){u.match=true}var t=new RegExp(u.pattern);o=t.test(v.value);if(!u.match){o=!o}if(!o&&!s&&q){var r=(w!=null)?w:"is invalid.";q.addError(r,v)}}return o};Alfresco.forms.validation.repoRegexMatch=function j(t,p,s,r,o,q){p.pattern=p.expression;p.match=p.requiresMatch;return Alfresco.forms.validation.regexMatch(t,p,s,r,o,q)};Alfresco.forms.validation.validDateTime=function a(t,p,s,r,o,q){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Validating field '"+t.id+"' has a valid date and time")}return !YAHOO.util.Dom.hasClass(t,"invalid")};Alfresco.forms.validation.inList=function h(t,p,s,r,o,q){return true}})();