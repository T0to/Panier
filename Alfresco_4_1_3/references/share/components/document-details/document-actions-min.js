(function(){var h=YAHOO.util.Dom;var e=Alfresco.util.encodeHTML,f=Alfresco.util.combinePaths,g=Alfresco.util.siteURL;Alfresco.DocumentActions=function(n){Alfresco.DocumentActions.superclass.constructor.call(this,"Alfresco.DocumentActions",n,["button"]);this.actionsView="details";YAHOO.Bubbling.on("filesPermissionsUpdated",this.doRefresh,this);YAHOO.Bubbling.on("metadataRefresh",this.doRefresh,this);YAHOO.Bubbling.on("registerAction",this.onRegisterAction,this);return this};YAHOO.extend(Alfresco.DocumentActions,Alfresco.component.Base);YAHOO.lang.augmentProto(Alfresco.DocumentActions,Alfresco.doclib.Actions);YAHOO.lang.augmentObject(Alfresco.DocumentActions.prototype,{options:{nodeRef:null,siteId:null,containerId:"documentLibrary",inlineEditMimetypes:{"text/plain":true,"text/html":true,"text/xml":true},rootNode:"alfresco://company/home",replicationUrlMapping:{},documentDetails:null,repositoryBrowsing:true},recordData:null,doclistMetadata:null,currentPath:null,onReady:function c(){var z=this;this.recordData=this.options.documentDetails.item;this.doclistMetadata=this.options.documentDetails.metadata;this.currentPath=this.recordData.location.path;this.recordData.jsNode=new Alfresco.util.Node(this.recordData.node);var v=this.recordData,o=v.node,p=v.actions,q=h.get(this.id+"-actionSet"),y="",u;v.actionParams={};for(var t=0,C=p.length;t<C;t++){y+=this.renderAction(p[t],v)}var n=this.getActionUrls(v);q.innerHTML=YAHOO.lang.substitute(y,n);h.addClass(q,"action-set");h.setStyle(q,"visibility","visible");var A=v.displayName,s=n.downloadUrl;var B=function w(F,E){var D=YAHOO.Bubbling.getOwnerByTagName(E[1].anchor,"div");if(D!==null){if(typeof z[D.title]==="function"){E[1].stop=true;try{z[D.title].call(z,z.recordData,D)}catch(G){Alfresco.logger.error("DocumentActions_fnActionHandler",D.title,G)}}}return true};YAHOO.Bubbling.addDefaultAction("action-link",B);this.modules.actions=new Alfresco.module.DoclibActions();if(window.location.hash=="#editOffline"){window.location.hash="";if(YAHOO.env.ua.ie>6){Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.edit-offline.success",A),text:this.msg("message.edit-offline.success.ie7"),buttons:[{text:this.msg("button.download"),handler:function r(){window.location=s;this.destroy()},isDefault:true},{text:this.msg("button.close"),handler:function x(){this.destroy()}}]})}else{Alfresco.util.PopupManager.displayMessage({text:this.msg("message.edit-offline.success",A)});YAHOO.lang.later(3000,this,function(){window.location=s})}}if(window.location.hash=="#editCancelled"){window.location.hash="";Alfresco.util.PopupManager.displayMessage({text:this.msg("message.edit-cancel.success",A)})}if(window.location.hash=="#checkoutToGoogleDocs"){window.location.hash="";Alfresco.util.PopupManager.displayMessage({text:this.msg("message.checkout-google.success",A)})}if(window.location.hash=="#checkinFromGoogleDocs"){window.location.hash="";Alfresco.util.PopupManager.displayMessage({text:this.msg("message.checkin-google.success",A)})}},onActionEditOffline:function b(p){var n=p.displayName,o=new Alfresco.util.NodeRef(p.nodeRef);this.modules.actions.genericAction({success:{callback:{fn:function q(r){this.recordData.jsNode.setNodeRef(r.json.results[0].nodeRef);window.location=this.getActionUrls(this.recordData).documentDetailsUrl+"#editOffline"},scope:this}},failure:{message:this.msg("message.edit-offline.failure",n)},webscript:{method:Alfresco.util.Ajax.POST,name:"checkout/node/{nodeRef}",params:{nodeRef:o.uri}}})},onActionCancelEditing:function j(q){var n=q.displayName,p=new Alfresco.util.NodeRef(q.nodeRef);this.modules.actions.genericAction({success:{callback:{fn:function o(t){var s=this.recordData.jsNode.nodeRef.nodeRef,r=t.json.results[0].nodeRef;this.recordData.jsNode.setNodeRef(r);window.location=this.getActionUrls(this.recordData).documentDetailsUrl+"#editCancelled";if(s==r){window.location.reload()}},scope:this}},failure:{message:this.msg("message.edit-cancel.failure",n)},webscript:{method:Alfresco.util.Ajax.POST,name:"cancel-checkout/node/{nodeRef}",params:{nodeRef:p.uri}}})},onActionUploadNewVersion:function k(r){var o=r.displayName,q=new Alfresco.util.NodeRef(r.nodeRef),n=r.version;if(!this.fileUpload){this.fileUpload=Alfresco.getFileUploadInstance()}var t=this.msg("label.filter-description",o),p="*";if(o&&new RegExp(/[^\.]+\.[^\.]+/).exec(o)){p="*"+o.substring(o.lastIndexOf("."))}if(r.workingCopy&&r.workingCopy.workingCopyVersion){n=r.workingCopy.workingCopyVersion}var s={updateNodeRef:q.toString(),updateFilename:o,updateVersion:n,suppressRefreshEvent:true,overwrite:true,filter:[{description:t,extensions:p}],mode:this.fileUpload.MODE_SINGLE_UPDATE,onFileUploadComplete:{fn:this.onNewVersionUploadCompleteCustom,scope:this}};if(Alfresco.util.isValueSet(this.options.siteId)){s.siteId=this.options.siteId;s.containerId=this.options.containerId}this.fileUpload.show(s)},onNewVersionUploadCompleteCustom:function a(n){this.onNewVersionUploadComplete.call(this,n);this.recordData.jsNode.setNodeRef(n.successful[0].nodeRef);YAHOO.lang.later(0,this,function(){window.location=this.getActionUrls(this.recordData).documentDetailsUrl})},onActionCheckoutToGoogleDocs:function i(q){var n=q.displayName,p=new Alfresco.util.NodeRef(q.nodeRef),r=q.location.path,u=q.fileName;var t=Alfresco.util.PopupManager.displayMessage({displayTime:0,effect:null,text:this.msg("message.checkout-google.inprogress",n)});this.modules.actions.genericAction({success:{callback:{fn:function s(v){this.recordData.jsNode.setNodeRef(v.json.results[0].nodeRef);window.location=this.getActionUrls(this.recordData).documentDetailsUrl+"#checkoutToGoogleDocs"},scope:this},activity:{siteId:this.options.siteId,activityType:"google-docs-checkout",page:"document-details",activityData:{fileName:u,path:r,nodeRef:p.toString()}}},failure:{callback:{fn:function o(v){t.destroy();Alfresco.util.PopupManager.displayMessage({text:this.msg("message.checkout-google.failure",n)})},scope:this}},webscript:{method:Alfresco.util.Ajax.POST,name:"checkout/node/{nodeRef}",params:{nodeRef:p.uri}}})},onActionCheckinFromGoogleDocs:function l(s){var u=s.displayName,v=new Alfresco.util.NodeRef(s.nodeRef),p,o=false,w=s.location.path,r=s.fileName;if(s.jsNode.hasAspect("cm:checkedOut")){v=new Alfresco.util.NodeRef(s.workingCopy.workingCopyNodeRef);p=new Alfresco.util.NodeRef(s.nodeRef);o=true}else{p=new Alfresco.util.NodeRef(s.workingCopy.sourceNodeRef)}var t=Alfresco.util.PopupManager.displayMessage({displayTime:0,effect:null,text:this.msg("message.checkin-google.inprogress",u)});this.modules.actions.genericAction({success:{callback:{fn:function n(x){this.recordData.jsNode.setNodeRef(x.json.results[0].nodeRef);window.location=this.getActionUrls(this.recordData).documentDetailsUrl+"#checkinFromGoogleDocs";if(o){window.location.reload()}},scope:this},activity:{siteId:this.options.siteId,activityType:"google-docs-checkin",page:"document-details",activityData:{fileName:u,path:w,nodeRef:p.toString()}}},failure:{fn:function q(x){t.destroy();Alfresco.util.PopupManager.displayMessage({text:this.msg("message.checkin-google.failure",u)})},scope:this},webscript:{method:Alfresco.util.Ajax.POST,name:"checkin/node/{nodeRef}",params:{nodeRef:v.uri}}})},_onActionDeleteConfirm:function m(r){var s=r.location.path,u=r.fileName,n=r.displayName,q=new Alfresco.util.NodeRef(r.nodeRef),t=Alfresco.util.isValueSet(this.options.siteId)?"documentlibrary":"repository",o=s.length>1?"?path="+encodeURIComponent(s):"";this.modules.actions.genericAction({success:{activity:{siteId:this.options.siteId,activityType:"file-deleted",page:"documentlibrary",activityData:{fileName:u,path:s,nodeRef:q.toString()}},callback:{fn:function p(v){window.location=g(t+o)}}},failure:{message:this.msg("message.delete.failure",n)},webscript:{method:Alfresco.util.Ajax.DELETE,name:"file/node/{nodeRef}",params:{nodeRef:q.uri}}})},doRefresh:function d(){YAHOO.Bubbling.unsubscribe("filesPermissionsUpdated",this.doRefresh,this);YAHOO.Bubbling.unsubscribe("metadataRefresh",this.doRefresh,this);this.refresh("components/document-details/document-actions?nodeRef={nodeRef}"+(this.options.siteId?"&site={siteId}":""))}},true)})();