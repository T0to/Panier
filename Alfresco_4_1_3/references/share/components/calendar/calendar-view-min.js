(function(){var G=YAHOO.util.Dom,F=YAHOO.util.Event,k=YAHOO.util.Selector,E=Alfresco.util.encodeHTML,P=Alfresco.util.fromISO8601,d=Alfresco.util.toISO8601,t=Alfresco.thirdparty.dateFormat;Alfresco.CalendarView=function v(Q){this.id=Q;Alfresco.CalendarView.superclass.constructor.call(this,"Alfresco.CalendarView",Q,["calendar","button","resize","datasource","datatable","history"]);return this};YAHOO.extend(Alfresco.CalendarView,Alfresco.component.Base,{widgets:{},modules:{},popups:{},handlers:{},data:{},calendarView:"",initEvents:function a(){F.on(this.id,"click",this.onInteractionEvent,this,true);F.on(this.id,"dblclick",this.onInteractionEvent,this,true);YAHOO.Bubbling.on("eventEdited",this.onEventEdited,this);YAHOO.Bubbling.on("eventEditedAfter",this.onAfterEventEdited,this);YAHOO.Bubbling.on("eventSaved",this.onEventSaved,this);YAHOO.Bubbling.on("eventSavedAfter",this.onAfterEventSaved,this);YAHOO.Bubbling.on("eventDeleted",this.onEventDeleted,this);YAHOO.Bubbling.on("eventDeletedAfter",this.onAfterEventDeleted,this);YAHOO.Bubbling.on("tagSelected",this.onTagSelected,this);YAHOO.Bubbling.on("viewChanged",this.onViewChanged,this);YAHOO.Bubbling.on("dateChanged",this.onCalSelect,this);YAHOO.Bubbling.on("formValidationError",this.onFormValidationError,this);if(this.calendarView==Alfresco.CalendarView.VIEWTYPE_DAY|this.calendarView==Alfresco.CalendarView.VIEWTYPE_WEEK){YAHOO.Bubbling.on("eventResized",this.onEventResized,this)}},getEvents:function n(){Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"calendar/events/"+this.options.siteId+"/user",dataObj:{from:d(this.options.startDate).split("T")[0],to:d(this.options.endDate).split("T")[0],repeating:"all"},successCallback:{fn:this.onEventsLoaded,scope:this},failureMessage:Alfresco.util.message("load.fail","Alfresco.CalendarView")})},render:function w(){if(this.calendarView===Alfresco.CalendarView.VIEWTYPE_AGENDA){this.initEvents();this.getEvents(t(this.options.startDate,"yyyy-mm-dd"))}else{this.renderEvents()}},displayMessage:function j(R,Q){Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message(R,Q||this.name)})},getEventObj:function M(Q){if(typeof(Q.innerHTML)==="string"){return this.parseRel(Q)}else{return Q}},getRel:function q(Q){return Q.from.split("T")[0]},parseRel:function l(T){var V,U="",R="",Q=false;if(k.test(T,"div.yui-dt-liner")){T=G.getElementsByClassName("summary","a",T.parentNode.parentNode)[0]}if(T.rel!==""&&T.rel!==undefined){R=T.rel;U=this.widgets.Data[R].events;for(var S=0;S<U.length;S++){if(U[S].uri==="/calendar/event/"+T.href.split("/calendar/event/")[1]){Q=U[S]}}}return Q},toggleEarlyTableRows:function O(){var T=YAHOO.util.Dom.get("collapseTrigger");this.earlyEls=YAHOO.util.Dom.getElementsByClassName("early","tr",T.parentNode);var Q=(YAHOO.env.ua.ie)?"block":"table-row";for(var R=0;R<this.earlyEls.length;R++){var S=this.earlyEls[R];YAHOO.util.Dom.setStyle(S,"display",(this.isShowingEarlyRows)?"none":Q)}this.isShowingEarlyRows=!this.isShowingEarlyRows},onEventsLoaded:function y(R){var V=YAHOO.lang.JSON.parse(R.serverResponse.responseText).events;var X=[];var ac=[];var T=null;var ab=this.options.startDate;var Z=this.options.endDate;var Q=this.options.siteId;YAHOO.Bubbling.fire("eventDataLoad",V);for(var U=0;U<V.length;U++){var Y=V[U];Y.title=E(Y.title);Y.where=E(Y.where);Y.description=E(Y.description);if(Y.site==Q){X.push(Y)}}V=X;T=function(){return function(af,ah){var ae=(af<=ab&&Z<=ah);var ad=(af>=ab&&af<Z);var ag=(ah>=ab&&ah<Z);return(ae||ad||ag)}}.apply(this);for(var U=0;U<V.length;U++){var Y=V[U];var S=P(Y.startAt.iso8601);var W=P(Y.endAt.iso8601);if(T(S,W)){var aa={};aa.desc=Y.description||"";aa.name=Y.title;aa.isoutlook=Y.isoutlook=="true"?"isoutlook":"";aa.contEl="div";aa.from=Y.startAt.iso8601;aa.to=Y.endAt.iso8601;aa.uri="/calendar/event/"+this.options.siteId+"/"+Y.name+"?date="+Y.startAt.iso8601;aa.hidden="";aa.allday="";aa.isMultiDay=(!Alfresco.CalendarHelper.isSameDay(S,W));aa.isAllDay=(Y.allday=="true")?true:false;aa.el="div";aa.key=aa.from.split(":")[0]+":00";aa=YAHOO.lang.merge(Y,aa);ac.push(aa)}}this.renderEvents(ac)},add:function A(R,Q){this.add(R,Q)},remove:function o(Q){this.remove(Q)},update:function x(R,Q){this.data.update(Q)},filterMultiday:function I(ab){var T=YAHOO.widget.DateMath;for(var V=0,aa=ab.length;V<aa;V++){var Q=ab[V];if(Q.isMultiDay){var Y=Q.from.split("T"),Z=Q.to.split("T"),W=P(Y[0]),S=P(Z[0]),X=new Date(W+86400000);if(!Q.isAllDay){Q.displayEnd="00:00"}for(var U=0,X=T.add(W,T.DAY,1);X.getTime()<=S.getTime();X=T.add(X,T.DAY,1)){var R=YAHOO.lang.merge(Q);R.isCloned=true;R.clonedFromDate=Q.from;if(!Q.isAllDay){if(!Alfresco.CalendarHelper.isSameDay(X,S)){R.isAllDay=true}else{R.displayStart="00:00";delete R.displayEnd}}R.displayFrom=d(X);ab.push(R)}}}return ab},removeMultipleDayEvents:function h(R){var T=G.getElementsByClassName(R.id+"-multiple");for(var S=0,Q=T.length;S<Q;S++){T[S].parentNode.removeChild(T[S])}},getClickedDate:function K(R){var Q=this.options.titleDate;if(R.nodeName.toUpperCase()!=="TD"){R=G.getAncestorByTagName(R,"td")}if(R){Q=P(R.id.replace("cal-",""))}return Q},showAddDialog:function B(R){var Q;if(YAHOO.lang.isUndefined(R)){this.currentDate=Q=(Alfresco.util.getQueryStringParameter("date"))?P(Alfresco.util.getQueryStringParameter("date")):new Date()}else{this.currentDate=Q=R}if(this.eventDialog){this.eventDialog.dialog.destroy();delete this.eventDialog}var S=new Alfresco.EventInfo(this.id);this.eventDialog=S.initEditDialog({actionUrl:Alfresco.constants.PROXY_URI+"calendar/create",ajaxSubmitMethod:Alfresco.util.Ajax.POST,displayDate:Q,templateRequestParams:{site:this.options.siteId},onSuccess:{fn:this.onEventSaved,scope:this},onFailure:{fn:this.onEventSaveFailed,scope:this}});this.eventDialog.show()},showDialog:function(R,S){var Q=this.getEventObj(S);this.setUpDialog(R,S,Q);if(!this.eventInfoPanel.isShowing){this.eventInfoPanel.show(Q)}F.preventDefault(R)},deleteDialog:function(R,S){var Q=this.getEventObj(S);this.setUpDialog(R,S,Q);this.eventInfoPanel.onDeleteClick();F.preventDefault(R)},editDialog:function(R,S){var Q=this.getEventObj(S);this.setUpDialog(R,S,Q);this.eventInfoPanel.onEditClick();F.preventDefault(R)},setUpDialog:function(R,S,Q){var T=document.createElement("div");T.id="eventInfoPanel";document.body.appendChild(T);this.eventInfoPanel=new Alfresco.EventInfo(this.id);this.eventInfoPanel.event=Q;if(!this.eventInfoPanel.isShowing){this.eventInfoPanel.setOptions({siteId:this.options.siteId,eventUri:Q.uri.substring(1,Q.uri.length),displayDate:this.currentDate,event:Q,permitToEditEvents:this.options.permitToCreateEvents})}},isValidDateForView:function(Q){return(Q.getTime()>=this.options.startDate.getTime())&&(Q.getTime()<this.options.endDate.getTime())},onCancelDialog:function z(){this.eventDialog.hide()},onDateSelected:function D(T,Q,S){if(this.currPopUpCalContext){for(var R=1;R<Q[0][0].length;R++){Q[0][0][R]=Alfresco.CalendarHelper.padZeros(Q[0][0][R])}G.get(this.currPopUpCalContext).value=Q[0][0].join("-");if(this.currPopUpCalContext==="dtend"){G.get(this.currPopUpCalContext+"time").value=YAHOO.widget.DateMath.add(P(G.get("dtstart").value+"T"+G.get("dtstarttime").value),YAHOO.widget.DateMath.HOUR,1).format(t.masks.isoTime)}}},onReady:function i(){this.calendarView=this.options.view;this.startDate=(YAHOO.lang.isString(this.options.startDate))?P(this.options.startDate):this.options.startDate;this.container=G.get(this.id);this.containerRegion=G.getRegion(this.container);this.isShowingEarlyRows=true;this.titleEl=G.get("calTitle");if(!YAHOO.widget.DateMath.HOUR){YAHOO.widget.DateMath.add=function(){var Q=YAHOO.widget.DateMath.add;YAHOO.widget.DateMath.HOUR="H";YAHOO.widget.DateMath.SECOND="S";YAHOO.widget.DateMath.MINUTE="Mn";return function(S,U,T){switch(U){case YAHOO.widget.DateMath.MONTH:case YAHOO.widget.DateMath.DAY:case YAHOO.widget.DateMath.YEAR:case YAHOO.widget.DateMath.WEEK:return Q.apply(YAHOO.widget.DateMath,arguments);break;case YAHOO.widget.DateMath.HOUR:var V=S.getHours()+T;var R=0;if(V<0){while(V<0){V+=24;R-=1}}if(V>24){while(V>24){V-=24;R+=1}}YAHOO.widget.DateMath._addDays(S,R);S.setHours(V);break;case YAHOO.widget.DateMath.MINUTE:S.setMinutes(S.getMinutes()+T);break;case YAHOO.widget.DateMath.SECOND:S.setMinutes(S.getSeconds()+T)}return S}}()}this.render()},onInteractionEvent:function e(T,Q){var S,R;if(typeof(T.event)==="object"&&typeof(T.target)==="object"){R=T.event;S=T.target}else{R=T;S=F.getTarget(R)}if(R.type==="mouseover"){if(k.test(S,"div."+this.dragGroup)){G.addClass(S,"highlight");if(this.options.permitToCreateEvents){if(!G.hasClass(S,"disabled")){S.appendChild(this.addButton)}}}}else{if(R.type==="mouseout"){if(k.test(S,"div."+this.dragGroup)){G.addClass(S,"highlight")}}else{if(R.type==="click"){if(k.test(S,"a#collapseTriggerLink")){this.toggleEarlyTableRows();F.preventDefault(R)}else{if(k.test(S,"button#addEventButton")||k.test(S.offsetParent,"button#addEventButton")||k.test(S,"a.addEvent")){this.showAddDialog();F.preventDefault(R)}else{if(k.test(S,"a.summary")||k.test(S,"div.yui-dt-liner")){this.showDialog(R,S)}else{if(k.test(S,"li.moreEvents a")){this.onShowMore(R,Q,S)}else{if(k.test(S,"a.showMore")){this.expandDescription(S);F.preventDefault(R)}else{if(k.test(S,"a.showLess")){this.collapseDescription(S);F.preventDefault(R)}else{if(k.test(S,"a.deleteAction")){this.deleteDialog(R,S)}else{if(k.test(S,"a.editAction")){this.editDialog(R,S)}}}}}}}}}}}},onTodayNav:function r(){var Q=new Date();var R=Alfresco.util.getQueryStringParameters();R.date=Q.getFullYear()+"-"+Alfresco.CalendarHelper.padZeros((~~(1*(Q.getMonth())))+1)+"-"+Alfresco.CalendarHelper.padZeros(Q.getDate());window.location=window.location.href.split("?")[0]+Alfresco.util.toQueryString(R)},onViewChanged:function L(){var R=Alfresco.util.getQueryStringParameters(),Q=window.location.hash;dateBookmark=Q.substring(Q.indexOf("date=")+5).split("&")[0];R.view=Alfresco.util.ComponentManager.findFirst("Alfresco.CalendarToolbar").enabledViews[arguments[1][1].activeView];if(dateBookmark!==""){R.date=dateBookmark}window.location=window.location.href.split("?")[0].split("#")[0]+Alfresco.util.toQueryString(R)},onCalSelect:function s(T,S){var R=S[1].date;var U=Alfresco.util.getQueryStringParameters();U.date=t(R,"yyyy-mm-dd");var Q=window.location.href.split("?")[0]+Alfresco.util.toQueryString(U);window.location=Q},onTagSelected:function p(T,Q){var R=arguments[1][1].tagname,S=false;if(R==Alfresco.util.message("label.all-tags","Alfresco.TagComponent")){this.options.tag=null}else{this.options.tag=R}this.updateTitle();this.getEvents()},onFormValidationError:function c(R,Q){Q=Q[1];Alfresco.util.PopupManager.displayMessage({text:Q.msg})},onEventEdited:function f(Q,R){this.getEvents();YAHOO.Bubbling.fire("eventEditedAfter")},onEventSaved:function C(R){this.getEvents();var Q=YAHOO.lang.JSON.parse(R.serverResponse.responseText);if(!Q.error){YAHOO.Bubbling.fire("eventSavedAfter");this.displayMessage("message.created.success",this.name)}else{this.onEventSaveFailed()}},onEventSaveFailed:function u(){Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("message.created.failure",this.name)})},onEventDeleted:function N(){this.getEvents();YAHOO.Bubbling.fire("eventDeletedAfter");this.msg("message.deleted.success",this.name)},onAfterEventSaved:function b(R,Q){this.refreshTags();this.displayMessage("message.created.success",this.name)},onAfterEventDeleted:function m(R,Q){this.refreshTags();this.displayMessage("message.deleted.success",this.name)},onAfterEventEdited:function m(R,Q){this.refreshTags()},refreshTags:function g(){YAHOO.lang.later(500,YAHOO.Bubbling,"fire","tagRefresh")},updateTitle:function H(){return},tagFilter:function J(V){var S=[],U=this.options.tag;if(!U){return V}else{for(var T=0,Q=V.length;T<Q;T++){var R=V[T].tags;if(typeof(R)==="string"){R=R.split(" ")}if(Alfresco.util.arrayContains(R,U)){S.push(V[T])}}return S}}});Alfresco.CalendarView.VIEWTYPE_WEEK="week";Alfresco.CalendarView.VIEWTYPE_MONTH="month";Alfresco.CalendarView.VIEWTYPE_DAY="day";Alfresco.CalendarView.VIEWTYPE_AGENDA="agenda"})();Alfresco.CalendarHelper=(function Alfresco_CalendarHelper(){var a=YAHOO.util.Dom,s=YAHOO.util.Event,t=YAHOO.util.Selector,g=Alfresco.util.fromISO8601,i=Alfresco.util.toISO8601,o=Alfresco.thirdparty.dateFormat;var f=[];return{getEndDate:function b(u,x){var v=Alfresco.util.fromISO8601(u);for(var w in x){v=YAHOO.widget.DateMath.add(v,(w==="M")?YAHOO.widget.DateMath.MINUTE:w,(~~(1*x[w])))}return Alfresco.util.toISO8601(v).split("+")[0]},determineHourSegment:function n(v,z){var A=a.getRegion(z);var B=v[1];var u=Math.round((A.bottom-A.top)/2);var x=(!a.getPreviousSibling(z));var w=a.getAncestorByTagName(z,"tr").getElementsByTagName("h2")[0].innerHTML;if(x===true){w=(B-A.top<u)?w:w.replace(":00",":15")}else{w=(B-A.top<u)?w.replace(":00",":30"):w.replace(":00",":45")}return w},getDuration:function h(z,v){var y=v.getTime()-z.getTime();var w={};var x="P";var y=new Date();y.setTime(Math.abs(v.getTime()-z.getTime()));var u=y.getTime();w[YAHOO.widget.DateMath.WEEK]=Math.floor(u/(1000*60*60*24*7));u-=w[YAHOO.widget.DateMath.WEEK]*(1000*60*60*24*7);w[YAHOO.widget.DateMath.DAY]=(Math.floor(u/(1000*60*60*24)));u-=w[YAHOO.widget.DateMath.DAY]*(1000*60*60*24);w[YAHOO.widget.DateMath.HOUR]=Math.floor(u/(1000*60*60));u-=w[YAHOO.widget.DateMath.HOUR]*(1000*60*60);w[YAHOO.widget.DateMath.MINUTE]=Math.floor(u/(1000*60));u-=w[YAHOO.widget.DateMath.MINUTE]*(1000*60);w[YAHOO.widget.DateMath.SECOND]=Math.floor(u/1000);u-=w[YAHOO.widget.DateMath.SECOND]*1000;if(w[YAHOO.widget.DateMath.WEEK]>0){x+=w[YAHOO.widget.DateMath.WEEK]+YAHOO.widget.DateMath.WEEK}if(w[YAHOO.widget.DateMath.DAY]>0){x+=w[YAHOO.widget.DateMath.DAY]+YAHOO.widget.DateMath.DAY}x+="T";if(w[YAHOO.widget.DateMath.HOUR]>0){x+=w[YAHOO.widget.DateMath.HOUR]+YAHOO.widget.DateMath.HOUR}if(w[YAHOO.widget.DateMath.MINUTE]>0){x+=w[YAHOO.widget.DateMath.MINUTE]+"M"}if(w[YAHOO.widget.DateMath.SECOND]>0){x+=w[YAHOO.widget.DateMath.SECOND]+YAHOO.widget.DateMath.SECOND}return x},padZeros:function r(u){return(u<10)?"0"+u:u},getDateFromField:function d(v){var u=v.title;var w=(u!=="")?g(u):new Date();return w},writeDateToField:function p(u,v){var w=o(u,Alfresco.util.message("date-format.fullDate"));v.value=w;v.title=i(u)},addTemplate:function j(u,v){f[u]=v},getTemplate:function m(u){return f[u]},renderTemplate:function c(u,x){var w=document.createElement("div");if(f[u]&&w){var w=YAHOO.lang.isString(w)?a.get(w):w;var v=f[u];var y=document.createElement("div");if(x){v=YAHOO.lang.substitute(v,x)}y.innerHTML=v;w.appendChild(y.firstChild);return w.lastChild}},isValidDate:function k(v,u){return v.getTime()<u.getTime()},isSameDay:function q(v,u){if(typeof(v)==="string"){v=g(v)}if(typeof(u)==="string"){u=g(u)}return(v.getDate()===u.getDate()&&v.getMonth()===u.getMonth()&&v.getFullYear()===u.getFullYear())},isBefore:function l(v,u){if(typeof(v)==="string"){v=g(v)}if(typeof(u)==="string"){u=g(u)}return(v<u)},isAllDay:function e(v){var w=this.isSameDay(v.from,v.to);var u=(v.end==v.start&&"00:00")?true:false;return(!w&&u)}}})();Alfresco.CalendarHelper.addTemplate("vevent",'<{el} class="vevent {allday} {hidden} {isoutlook} theme-bg-color-1 theme-border-2"> <{contEl}><p class="dates"><span class="dtstart" title="{from}">{start}</span> - <span class="dtend" title="{to}">{end}</span></p><p class="description">{desc}</p><a class="summary theme-color-1" href="{uri}">{name}</a><span class="location">{where}</span><span class="duration" title="{duration}">{duration}</span><span class="category">{tags}</span></{contEl}></{el}>');Alfresco.CalendarHelper.addTemplate("agendaDay","<h2>{date}</h2>");Alfresco.CalendarHelper.addTemplate("agendaDayItem",'<li class="vevent"><span>{start} - {end}</span><a href="{uri}" class="summary">{name}</a></li>');Alfresco.CalendarHelper.addTemplate("createEventButton",'<button id="addEventButton"><img src="{addEventUrl}" alt="{addEvent}" /></button>');Alfresco.CalendarHelper.addTemplate("taggedTitle",'<span class="tagged">{taggedWith} <span class="theme-color-2">\'{tag}\'</span></span>');